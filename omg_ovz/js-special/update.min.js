"use strict";var messageContainer=$("#message-container"),processContainer=$("#process-container"),newVersion=$("#new-version"),noEnter=$("#no-enter"),yesEnter=$("#yes-enter"),waitLoad=$("#wait-load"),startUpdate=$("#start-update"),progressbarContainer=$("#progressbar-container"),progressbar=$("#progressbar"),updateComplete=$("#update-complete"),filesForSync=[],btnExit=$("#exit"),parts=[];function Oauth(){this.setToken=function(){var e=window.localStorage.getItem("vikon_access_token"),t=window.localStorage.getItem("vikon_refresh_token"),n=window.localStorage.getItem("vikon_code");return new Promise(function(s){e?function(e){return new Promise(function(t){var n;$.post(apiDomen+"oauth2/resource/checkToken",{access_token:e}).done(function(e){n=!0}).fail(function(e){n=!1}).always(function(){return t(n)})})}(e).then(function(e){if(e)return s(!0);o()}):o();function o(){t?function(e){return new Promise(function(t){var n;$.post(domen+"/sveden/update/refresh_access_token.php",{refresh_token:e},function(e){return e.success?(window.localStorage.setItem("vikon_access_token",e.access_token),window.localStorage.setItem("vikon_refresh_token",e.refresh_token),n=!0):n=!1,t(n)})})}(t).then(function(e){if(e)return s(!0);r()}):r()}function r(){if(!n)return s(!1);(function(e){return new Promise(function(t){var n;$.post(domen+"/sveden/update/get_access_token.php",{code:e,domen:domen},function(e){return e.success?(window.localStorage.setItem("vikon_access_token",e.access_token),window.localStorage.setItem("vikon_refresh_token",e.refresh_token),n=!0):n=!1,t(n)})})})(n).then(function(e){return s(e)})}})},this.getToken=function(){return window.localStorage.getItem("vikon_access_token")},this.redirectUpdatePage=function(){window.location.href=domen+"/sveden/update"}}function Updater(){var url,data,onSuccess,onError,attempts=0,countFiles=0,loadedFiles=0,methodAjax="GET";this.setMethodAjax=function(e){methodAjax=e},this.setCountFiles=function(e){countFiles=e},this.incAndCheckLoadedFiles=function(){return++loadedFiles===countFiles},this.setUrl=function(e){url=e},this.setData=function(e){data=e},this.setOnSuccess=function(e){onSuccess=e},this.setOnError=function(e){onError=e},this.resetSettings=function(){url="",data={},onSuccess=void 0,onError=void 0,attempts=0,countFiles=0,loadedFiles=0,methodAjax="GET"},this.sendAjax=function(critical,nameFunc){return void 0===critical&&(critical=!0),void 0===methodAjax&&(methodAjax="GET"),new Promise(function(resolve){$.ajax({type:methodAjax,url:url,dataType:"json",data:data,success:function success(res){if(void 0!==onSuccess)return onSuccess(res),resolve(res);if(res.success){if(res.message&&processContainer.prepend("<p>"+res.message+"</p>"),critical)return resolve(res)}else if(void 0!==res.error&&"invalid_token"===res.error&&0===attempts&&void 0!==nameFunc){var promiseSetToken=oauth.setToken();promiseSetToken.then(function(success){if(success){attempts++,loadedFiles--,data.access_token=oauth.getToken();var promiseSend=updater.sendAjax();promiseSend.then(function(res){eval(nameFunc)})}else oauth.redirectUpdatePage()})}else res.message&&(processContainer.prepend('<p class="text-danger">Ошибка: '+res.message+"</p>"),progressbarContainer.hide());return critical?void 0:resolve(res)},error:function(e,t,n){void 0!==onError?onError(e,t,n):(processContainer.prepend('<p class="text-danger">Ошибка: '+t+" "+n+"</p>"),"Unauthorized"===n&&0===attempts&&(oauth.setToken(),attempts++,updater.sendAjax()))}})})},this.addMessage=function(e){processContainer.prepend("<p>"+e+"</p>")}}function ProgressbarControl(){this.setActive=function(){progressbar.addClass("active")},this.setDeactive=function(){progressbar.removeClass("active")},this.setVal=function(e){progressbar.css("width",e+"%"),progressbar.html(e+"%")}}function disabledAccess(e,t){-1===e.indexOf(t.val())&&(t.is(":checked")&&t.attr("checked",!1),t.attr("disabled",!0),t.parent().addClass("disabled"),t.next().prepend('<span class="text-danger">Нет прав</span> '))}if(window.localStorage){var oauth=new Oauth,updater=new Updater,progressControl=new ProgressbarControl;oauth.setToken().then(function(e){e?(updater.resetSettings(),updater.setUrl(apiDomen+"update/get_access_list"),updater.setData({access_token:oauth.getToken(),d:domen}),updater.setOnSuccess(function(e){e.success&&($('input[name="part"]').each(function(){disabledAccess(e.access,$(this))}),disabledAccess(e.access,$('input[name="sync"]')))}),updater.sendAjax().then(function(){waitLoad.remove(),yesEnter.show(),btnExit.show(),updater.setUrl(apiDomen+"update/version"),updater.setData({access_token:oauth.getToken(),d:domen}),updater.setOnSuccess(function(e){e.success&&currentVersion!==e.version?newVersion.removeClass("label-warning").addClass("label-success").html(e.version):(newVersion.removeClass("label-warning").addClass("label-default"),void 0!==e.message?(messageContainer.html(e.message).show(),newVersion.html("обновления недоступны")):newVersion.html("обновления отсутствуют"))}),updater.sendAjax()})):(waitLoad.remove(),noEnter.show())})}else waitLoad.remove(),messageContainer.html("Объект localStorage не поддерживается данным браузером. Пожалуйста, воспользуйтесь другим Internet-браузером.").show();function get(){progressControl.setActive(),progressControl.setVal(10),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/get_core.php"),updater.setData({access_token:oauth.getToken()}),updater.addMessage("Начинается обновление скриптов обновления."),updater.sendAjax(!0,"unpack(res)").then(function(e){unpack(e)})}function unpack(e){progressControl.setVal(20),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/unpack.php"),updater.setData({version:e.version,parts:parts}),$('input[name="part"]:checked').each(function(){parts.push($(this).val())}),updater.sendAjax(!0,"getPart(0)").then(function(e){getPart(0)})}function getPart(e){e<parts.length?(progressControl.setVal(20+2*e),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/get_part.php"),updater.setData({access_token:oauth.getToken(),part:parts[e]}),updater.sendAjax(!0,"getPart("+(e+1)+")").then(function(t){getPart(e+1)})):getCountFiles()}function getCountFiles(){progressControl.setVal(50),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/get_count_files.php"),updater.setData({access_token:oauth.getToken()}),updater.addMessage("Запрос количества файлов."),updater.sendAjax(!0,"res.count > 0 ? getPackFiles(res.count, 0) : complete(res)").then(function(e){e.count>0?getPackFiles(e.count,0):$('input[name="sync"]').is(":checked")?getFilesForSync():complete()})}function getPackFiles(e,t){if(t<=e){updater.resetSettings(),updater.setUrl(domen+"/sveden/update/get_pack_files.php"),updater.setData({access_token:oauth.getToken(),startFiles:t,filesForPart:5}),updater.sendAjax(!0,"getPackFiles("+e+", "+(t+5)+")").then(function(n){getPackFiles(e,t+5)})}else $('input[name="sync"]').is(":checked")?getFilesForSync():complete()}function getFilesForSync(){progressControl.setVal(60),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/get_files_for_sync.php"),updater.setData({access_token:oauth.getToken()}),updater.sendAjax(!0,"if (res.files.length > 0) { filesForSync = res.files; getPackFilesForSync(0); } else { cleaner();}").then(function(e){e.files.length>0?(filesForSync=e.files,getPackFilesForSync(0)):complete()})}function getPackFilesForSync(e){if(e<=filesForSync.length){for(var t=[],n=e;n<e+5;n++)n in filesForSync&&(t[t.length]=filesForSync[n]);updater.resetSettings(),updater.setUrl(domen+"/sveden/update/get_pack_files_for_sync.php"),updater.setData({access_token:oauth.getToken(),files:t}),updater.setMethodAjax("POST"),updater.sendAjax(!0,"getPackFilesForSync("+(e+5)+")").then(function(t){getPackFilesForSync(e+5)})}else updater.addMessage("Синхронизация файлов завершена."),complete()}function complete(){progressControl.setVal(80),updater.addMessage("Запрос завершения обновления."),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/complete.php"),updater.setData({access_token:oauth.getToken()}),updater.sendAjax(!0,"getFilesForSync()").then(function(e){cleaner()})}function cleaner(){progressControl.setVal(90),updater.addMessage("Начинается удаление временных файлов."),updater.resetSettings(),updater.setUrl(domen+"/sveden/update/cleaner.php"),updater.sendAjax(!0,"afterSyncFiles()").then(function(e){updateEnd()})}function updateEnd(){progressControl.setVal(100),progressControl.setDeactive(),updateComplete.html("Обновление успешно завершено.").show()}$("#enter-vikon").on("click",function(){window.location.href=apiDomen+"oauth2/authorize?response_type=code&client_id="+clientId+"&redirect_uri="+domen+"/sveden/update/index.php"}),btnExit.on("click",function(){window.localStorage&&(window.localStorage.removeItem("vikon_access_token"),window.localStorage.removeItem("vikon_refresh_token"),window.localStorage.removeItem("vikon_code"))}),$("#select-all").on("change",function(){var e=$(".settings-update").find('input[type="checkbox"]:enabled');$(this).is(":checked")?e.prop("checked",!0):e.prop("checked",!1)}),startUpdate.on("click",function(){startUpdate.hide(),progressbarContainer.show(),processContainer.show(),get()});